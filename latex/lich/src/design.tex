\chapter{设计}

设计在解决关键问题的同时，要降低实现，测试和维护的复杂度。

加强测试，通过重构降低复杂度。

分解问题，界定边界，降低复杂度

设计的基本原则

分离机制和策略，接口和实现

性能依赖于设计，在一定的设计下，取决于实现。

性能优化手段：并行，聚合，缓存等，根本在于设计，控制复杂度。

识别实体和关系，ERD，DFD等，FSM是机器语言。

核心概念：
\begin{compactenum}
\item 存储池/目录
\item 卷
\item 快照
\item 主机映射
\end{compactenum}

core thread边界，core\_request进入。

分布式副本一致性：clock版本机制，msgqueue离线消息处理。

性能：并发，聚合和cache等

元数据管理，非计算而来

快照树的实现

后台任务统一管理，包括：
\begin{compactenum}
\item recovery
\item balance
\item vol rm
\item snap rm
\item snap rollback
\item snap flat
\end{compactenum}

架构问题：
\begin{compactenum}
\item 元数据管理成本
\item 支持大容量卷
\item 支持ROW快照树
\item 诊断流程和工具
\item 性能profile
\end{compactenum}

\section{故障域}

对任一存储池，设故障域数为M，副本数为N，

当M>=N时，每个故障域内一个副本，随机分布；
当M<N时，
- 策略1，每个故障域内一个副本
- 策略2a，剩余的副本按策略1进行，直到写完所有副本数
- 策略2b，不写剩余副本

按策略2a：

case 1：故障域为2，副本数为3，则副本在故障域的分布为（2,1）或（1,2）
case 2：故障域为1，副本数为3，则副本在故障域的分布为 3

按策略2b：

case 1：故障域为2，副本数为3，则副本在故障域的分布为（1,1）
case 2：故障域为1，副本数为3，则副本在故障域的分布为（1) （副本数不能少于2个，分配失败）

同时，恢复过程须按以上故障域规则进行自动校正！！！

\section{存储池状态}

\begin{compactenum}
\item 不可用
\item 磁盘空间不足/READ ONLY
\item 降级
\item 正常/健康
\end{compactenum}

\section{诊断方法}

对需要改进的流程进行区分，找到最有潜力的改进机会，优先对需要改进的流程实施改进。如果不确定优先次序，企业多方面出手，就可能分散精力，
影响6σ管理的实施效果。业务流程改进遵循五步循环改进法，即DMAIC模式：

\begin{compactenum}
\item 定义[Define]——辨认需改进的产品或过程，确定项目所需的资源。
\item 测量[Measure]——定义缺陷，收集此产品或过程的表现作底线,建立改进目标。
\item 分析[Analyze]——分析在测量阶段所收集的数据，以确定一组按重要程度排列的影响质量的变量。
\item 改进[Improve]——优化解决方案，并确认该方案能够满足或超过项目质量改进目标。
\item 控制[Control]——确保过程改进一旦完成能继续保持下去,而不会返回到先前的状态。
\end{compactenum}

信息有多级：USE。诊断问题依赖于结构化的诊断方法PAT，解决问题也是，构建知识图谱。

欲分析问题，必分析事物发展的完整过程，包括每个参与者的生命周期模型，参与者之间的相互作用。

\section{检查清单checklist}

先宏观，后微观，致广大而尽精微

\begin{compactenum}
\item 集群健康情况
\item 数据一致性检查
\item 硬件
    \begin{compactenum}
    \item 磁盘
    \item 网络
    \item 内存
    \item CPU
    \item 操作系统
    \end{compactenum}
\item LICH
    \begin{compactenum}
    \item 后台任务，包括恢复,删除，快照后台任务等
    \item 日志
    \item core
    \end{compactenum}
\end{compactenum}
