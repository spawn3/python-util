\chapter{移动集采}

产品评估：功能和质量。质量包括：可靠性，性能，QoS，可扩展性（负载均衡），用户体验(管控，交互，接口)等方面。

性能不是一个值，而是不同场景下的特征曲线。性能是系统配置和负载的函数：$P=F(S, W)$。
精简配置，快照，故障，实现机制等因素都会影响性能及其抖动。

\section{TODO}

\begin{enumbox}
\item Pool
\item Volume size
\item Volume mv and copy
\item Volume IOPS QOS
\item Row2 Snapshot
\item Mapping
\item Recovery
\item Load Balance
\item 可靠性 Robustness
\item Performance
\item extentability
\end{enumbox}

\section{重要问题}

\subsection{存储池}

模型：概念及其关系。

重建状态和速度按存储池进行统计。

\subsection{卷}

\begin{enumbox}
\item 精简配置
\item 三副本
\item 扩容
\item 卷的QoS：IOPS
\item 全量拷贝和增量拷贝
\end{enumbox}

三副本 \info{三副本性能}

\subsection{快照}

\begin{enumbox}
\item 显示卷和快照的创建时间，名称，宿主，\hl{容量，存储池}。
\item 快照树是必须的
\item 快照验证：每个快照关联一个数据集。
\end{enumbox}

\subsection{映射}

数据访问和隔离机制，应按\hl{最小权限原则设计}。主机仅能访问映射到该主机的卷

\subsection{故障处理}

\begin{enumbox}
\item IO抖动
\item 重建
\end{enumbox}

\subsection{数据恢复}

触发策略，QoS，性能，状态。

\begin{enumbox}
\item 在线调整策略：应用优先，或恢复优先。
\item 负载调整到原来的20\%时，数据重建效率。
\item 显示恢复速度和状态，区分实际重构的，和跳过的
\item 拔出硬盘的存储池降级（数据冗余度发生下降，目前恢复进程是节点级的，与存储池没有直接关系，并且，在节点的维度上，存储池是有覆盖的，overlay network，\hl{按卷进行汇总}）
\item 磁盘漫游，存储系统不发生重建，且数据无异常
\item 模拟故障：单磁盘，单节点，单机架。要求：无读写中断。
\end{enumbox}

要研究的问题：
\begin{enumbox}
\item 在业务负载限定为标准负载的20\%的情况下，恢复性能如何？
\item 如业务IO和数据恢复并存，数据恢复会挤压到很小。原因是什么？\hl{如何做到恢复优先}？
\item 拔盘后，感知状态变化较慢。如\verb|md_chunk_set|不持久化meta，有无副作用？恢复时，也可不持久化。
\end{enumbox}

\subsection{QoS算法}

卷的IOPS和带宽，数据恢复的QoS，采用同一算法：令牌桶Token bucket。

按恒定速度往桶里加入令牌，任务会消费令牌。如果令牌不足，则任务进入等待状态。
目前，等待时间采用polling策略。等待一个较小的值（200us），唤醒后重新检查。

接口保持不变。

\begin{tcolorbox}
fio队列深度过大，iscsi会有优化，进行IO聚合提交。这样一来，前端工具看到的IOPS可能会有所不同。
但是，各层观察到的带宽应该一致，保证流量守恒。
\end{tcolorbox}

\subsection{负载均衡}

均衡有数据均衡和负载均衡之分。

单卷的负载均衡，因为FusionStor卷控制器绑定到core上，只能利用单核能力。
CPU利用率上有瓶颈。同时，开启polling模式，会独占core cpu。

\subsection{Misc}

VAAI

\section{不需要做的项}

\begin{enumbox}
\item 一致性组
\item 同步/异步远程复制
\item EC
\end{enumbox}
