% HDS移动项目待实现功能
%
% 2016.08.24

# 产品设计

<!--
<img src='images/ump.jpeg' style='width:640px;height=480px'>
-->

![UMP](images/ump.jpeg)

## 物理资源

分为几个层次：系统-保护域-节点-磁盘。

保护域可以分配给租户，供其使用，并限定其活动范围。
同一个卷的所有数据，不能跨保护域。
保护域之间，可以进行卷的迁移和复制。

对任意一个节点（主机），至多只能出现在一个保护域里。如果没有显式指定保护域，则假设该节点属于一个default保护域。
在没有创建保护域的时候，所有节点都属于default保护域。

## 多租户

由系统管理员创建租户，并分配资源，包括：配额，保护域，存储策略（副本数），QoS，访问控制策略。

租户对分配到的资源，可以自由使用，包括：创建自己的资源池，卷，快照等。

多个租户共享底层物理资源，并在界面和资源访问上进行隔离，一个租户无法看到另一个租户创建的资源，也无法使用。
如果使用iSCSI，采用CHAP认证方式。

## 属性继承

属性按照如下顺序进行继承：系统-租户-资源池-卷。如卷的副本数，按卷-资源池-租户-系统的顺序向上回溯，
取最先找到的值。

## iSCSI

主机通过iSCSI方式访问卷，访问需要认证，认证采用CHAP方式。

采用static targets方式，跳过discovery阶段，以突破iSCSI协议的最大缓冲区限制。

## REST API

REST API实现为全功能的系统管理接口，需要进行认证才能访问。

REST API采用多版本机制。

REST API为上层应用提供接口，用于构建管理控制台，Openstack Cinder Driver的实现等。

在实现上，REST API依赖各个节点上部署的代理进程，维护CMDB数据库。
CMDB数据库也是系统不可分割的部分，需要考虑其自身的HA机制。
在进行远程复制的情况下，也要同时复制该状态。

# LICH相关

## 一致性卷组

## 异步远程复制

配置：

- cluster: (cluster_id, server, port, interval)
- replink: (cluster_id, src, tgt, reptype, interval, mbps)

复制关系：复制类型，源卷，目标卷，QoS等

每一个卷的复制，作为一个任务来处理，可以查询任务的状态和进度，多个任务可以并行处理。
记录任务执行进度，可以resume。

通过控制数据发送速度来控制带宽占用，可以控制并发任务数和总体带宽占用。

如一个卷被设了primary flag，就不再接收数据。防止已切换了后，又接收到数据的情况。

## 保护域

保护域需要在管理控制台上予以展示，建议采用nohost模式进行部署。

需要支持不同保护域之间数据的迁移和复制。

## 列出大的pool

如果一个pool有大量的子项，list操作有问题，需要改进。

## iSCSI主机映射关系

可查看映射关系列表 (从lich3移植连接管理代码）。

可创建/删除指定逻辑卷与指定主机之间的映射关系。

对映射对象可设置QoS服务性能边界，包括IOPS/MBPS等性能限制。

卷的状态应包括映射的主机信息。

# 系统管理

## 服务设计(ITIL SD)

## 服务转换(ITIL ST)

### 许可管理

### 配置管理

### 版本管理

## 服务运营(ITIL SO)

### 操作日志

内容：记录管理人员的所有操作，包括但不限于：严重级别，时间，管理员，操作类型，操作对象等信息。

管理：应至少包括自动日志导出和日志删除功能，应限制或配置日志记录的访问权限，防止日志被非法修改或删除。

查看：用户可自定义关键字，对日志记录进行过滤筛选。

### 告警管理

告警事件的来源和分类：

目前的实现，一类事件是由扫描各个节点的syslog获取；
另一类事件，根据采集到的数据进行判断，预定义规则。

包括但不限于以下各项：

- 存储池空间不足
- 重建失败
- 卷个数过多
- 节点状态异常
- 磁盘状态异常
- 其它

告警级别：

- 危急的(critical)
- 主要的(major)
- 次要的(minor)
- 警告(warning)

需要定义监控项，并在监控项上定义触发器，定义通知方式。

告警事件记录在数据库里，同时在管理控制台上展示，
并能够通过SNMP协议的方式上报到运维平台，上报延时不超过20秒。

告警事件可以通过产生时间，级别，恢复情况，以及自定义告警字段进行过滤。

### 性能统计

性能数据的采集，涉及到性能监控和QoS。常见的系统性能指标如下：

- 吞吐量 (IOPS, BW)
- 延时
- 使用率

<!--
USE方法：

- 使用率
- 饱和度
- 错误数

-->

IOPS和带宽，度量的都是吞吐量。延时来度量资源对于给定工作负载时的响应情况。
使用率是基于时间的，或基于容量的。
有些性能指标需要区分读和写操作，如IOPS分为读和写IOPS，分别进行计量。

存储使用率，分为总量，使用量和余量。

下表列出不同类型的资源和需要监控的性能指标（Y：必选，O：可选）：

指标    卷    存储池 租户 系统 保护域 节点 磁盘
------- ----- ------ ---- ---- ------ ---- -----
CPU                                   O
Memory                                O
Storage       Y      Y    Y    Y
IOPS    Y     Y                            O
BW      Y     Y                            O
Latency Y     O                            O
------- ----- ------ ---- ---- ------ ---- -----

### QoS

#### 卷上的QoS

- IOPS和MBPS

#### 数据恢复的QoS

- 功能描述: 控制系统后台数据恢复进程所占用的带宽和IO处理资源，提供多种数据恢复的优先级策略。
- 功能要求: 至少提供优先前端应用或优先数据修复这两种优先级策略。在优先前端应用的策略中，数据修复仅在资源较空闲时进行；在优先数据修复策略中，后台恢复以最快速度完成，但卷仍然在线保持可用，仅性能有所降低。

目前采用控制线程数的方式。改进方案如下：

- 方案：控制每个节点上数据恢复的最大带宽。
- 配置：/dev/shm/lich4/nodectl/recovery/maxbandwidth
- 算法：节点上的恢复进程，实时统计当前占用带宽，根据配置值进行自动调节。如大于配置值，进入sleep模式。如小于配置值，继续进行恢复。

取值规则：

``` python
if (file_not_exists or maxbandwidth < 0):
     不做限制
elif maxbandwidth == 0:
     不进行数据恢复
else:
     正常处理
```

### 统计报表

块存储系统应提供统计报表功能。提供的统计量包括：
针对每个卷和存储池，周期性的统计其IOPS、带宽和流量（包括读操作、写操作）。

应能够针对统计项生成统计报表。

# 第三方接口

## Openstack Cinder Driver

## SNMP

通过轮询方式进行数据采集，先不实现。

实现通过snmptrap上报告警事件：

- 安装snmptrap工具
- 安装LICH-MIB.txt到/usr/share/snmp/mibs/
- snmptrap -v 2c -c public 192.168.251.33:162 "" LICH-MIB::trapEvent SNMPv2-MIB::sysLocation.0 s "just here"

目前支持向zabbix发送消息:

- snmptrapd收到消息后，调用snmptt进行处理，转换格式后写入一临时文件
- zabbix解析该文件（https://www.zabbix.com/documentation/2.4/manual/config/items/itemtypes/snmptrap）

服务进程：

- snmptrapd -d -On -Lo
- systemctl start snmptt
- systemctl start zabbix-server
- systemctl start zabbix-agent
